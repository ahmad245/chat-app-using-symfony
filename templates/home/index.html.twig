{% extends 'base.html.twig' %}

{% block title %}Hello HomeController!{% endblock %}

{% block body %}
<style>
   
</style>
  <div class="container clearfix">
    <div class="people-list" id="people-list">
      <div class="search">
        <input type="text" placeholder="search" />
        <i class="fa fa-search"></i>
      </div>
      <ul class="list list_user">
       
      </ul>
    </div>
    
    <div class="chat">
      <div class="chat-header clearfix">
        <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/195612/chat_avatar_01_green.jpg" alt="avatar" />
        
        <div class="chat-about">
          <div class="chat-with">Chat with Vincent Porter</div>
          <div class="chat-num-messages">already 1 902 messages</div>
        </div>
        <i class="fa fa-star"></i>
      </div> <!-- end chat-header -->
      
      <div class="chat-history">
        <ul class="messages">
          
         
          
        </ul>
        
      </div> <!-- end chat-history -->
      
      <div class="chat-message clearfix">
        <textarea name="message-to-send" id="message-to-send" placeholder ="Type your message" rows="3"></textarea>
                
        <i class="fa fa-file-o"></i> &nbsp;&nbsp;&nbsp;
        <i class="fa fa-file-image-o"></i>
        
        <button id="btn">Send</button>

      </div> <!-- end chat-message -->
      
    </div> <!-- end chat -->
    
  </div> <!-- end container -->

{% endblock %}

{% block javascripts %}
{{parent()}}
<script>
let listUser=document.querySelector('.list_user');
let messages=document.querySelector('.messages');
let message=document.getElementById('message-to-send');
let btn=document.getElementById('btn');
let convId;
const fetchMessages=(id)=>{
  messages.innerHTML="";
  return axios.get(`/messages/${id}`).then((response) => {
    response.data.forEach((el)=>{
         let me=document.createElement('li');
       //  let other=document.createElement('li');
         me.classList.add('clearfix');
         if(el.mine){
           me.innerHTML=`
            
            <div class="message-data align-right">
              <span class="message-data-time" >${el.createdAt}
              <span class="message-data-name" >Olia</span> <i class="fa fa-circle me"></i>
              
            </div>
            <div class="message other-message float-right">
              ${el.content}
            </div>
         
           `;
         }
         else{
            me.innerHTML=`
         
            <div class="message-data">
              <span class="message-data-name"><i class="fa fa-circle online"></i> Vincent</span>
              <span class="message-data-time">${el.createdAt}</span>
            </div>
            <div class="message my-message">
               ${el.content}
            </div>
          
            `;
         }

         messages.append(me);
        

    })
   

    console.log(response.data);
    return response.data;
  })
}
   const fetchUsers=()=>{
            let urlUser = "/conversations";
                  
				  return  axios.get(urlUser).then((response) => {
           // console.log(response)
            response.data.forEach((el)=>{
                  let li=document.createElement('li');
                    li.innerHTML=`
                      <li class="clearfix">
                        <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/195612/chat_avatar_01.jpg" alt="avatar" />
                    <div class="about">
                        <div class="name">${el.email}</div>
                        <div class="status">
                          <i class="fa fa-circle online"></i> online
                        </div>
                  </div>
                </li>
                    `;
                    li.addEventListener('click',fetchMessages.bind(null,el.conversationId))
                    listUser.append(li);
                     convId=el.conversationId;

            })
           
			      return response.data;
				}).catch((err) => {
				console.log(err);
				})
   }
     fetchUsers();

     btn.addEventListener('click',()=>{
       let content=message.value;
       axios.post(`/messages/${convId}`,{
         'content':content
       }).then((response) => {
         console.log(response.data);
          fetchMessages(convId)
       })
     })

  
</script>
{% endblock %}